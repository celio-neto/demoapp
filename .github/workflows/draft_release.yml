name: Create Draft Release

on:
  workflow_dispatch:
    inputs:
      version_input:
        description: 'New version number to bump'
        required: true

jobs:
  prepare_branch:
    name: Prepare release branch 
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
      - name: Create branch 
        shell: bash
        run: |
            set -x
            new_version=${{ github.event.inputs.version_input}}

            # Ensure the version follows the major minor  format 
            if [[ $new_version =~ ([A-Za-z0-9]+(\.[A-Za-z0-9]+)+) ]];
            then

              echo $new_version > cicd/version

              git config user.name "GitHub Actions Bot"
              git config user.email "<>"

              fastlane setVersionName
              git add .
              git commit -m "NOSTORY: Bump release to $new_version"   
              git checkout -b release/$new_version
              git push --set-upstream origin release/$new_version        
              git push 
            else
              echo "The version input does not follow schema X.X.X"
              exit 0         
            fi

    
  prepare_release:
    needs: prepare_branch
    name: Prepare draft release
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
      - name: Create draft prepare_release
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUBPAT }}
        run: |
          set -x
          VERSION=$(cat cicd/version)
          gh auth login --with-token  ${{ env.GH_TOKEN }} && \
          gh release create "acpp-$VERSION" -t "Release ${VERSION}" -d --generate-notes --target release/$VERSION
